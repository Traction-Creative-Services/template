(function ( $ ) {
    
    $.fn.search = function(options) {
        
        var defaults = {
            ajax_limit: 3,
            num_results: 5
        }
        
        if( options) $.extend(defaults, options);
        
        this.each(function() {
            this.append('<div id="searchResultsWrapper"></div>');
            this.on('keydown',function() {
                var query = this.val();
                if (query.length > defaults.ajax_limit) {
                    $.ajax({
                        url: '/search/searchResult/',
                        data: {
                            'query':query,
                            'ajax':true
                        },
                        method: 'POST',
                        success: function(data, query) {
                            var resultSet = JSON.parse(data);
                            var HTML = '<div class="search-results">';
                            $.each(resultSet.results, function(result) {
                                
                                var excerpt = result.searchable;
                                var queryPos = excerpt.indexOf(query);
                                var excerptStart = queryPos - 10;
                                var excerptEnd = queryPos + 10;
                                excerpt = excerpt.substring(excerptStart,excerptEnd);
                                
                                HTML += '<article class="search-result">';
                                HTML += '<a href="' + result.url + '">' + result.display_title + '</a>';
                                HTML += '<p class="small">' + excerpt + '</p>';
                            })
                            HTML += '</div>';
                            $('#searchResultsWrapper').html(HTML);
                        }
                    })
                }
            })
        })
    }
    
    
}) ( jQuery );

$(document).on('click','#doIndex', function() { searchAdmin.doIndex(); });
$(document).on('click','#autoMap', function() { searchAdmin.toggleWarning(); })


var searchAdmin = {
    showedWarning: false,
    
    doIndex: function() {
        var map = $("#map").val();
        var autoMap = $("#autoMap").val();
        $('#logstring').append('begining map indexing <br />');
        $.ajax({
            url: 'indexSite',
            data: {
                'indexMap':map,
                'autoMap':autoMap
            },
            method: 'POST',
            success: function(data) {
                var arr = JSON.parse(data);
                var msg = arr[0];
                $("#logstring").append(msg + "<br/>");
            }
        })
    },
    
    toggleWarning: function() {
        var warningMsg = '<span style="color:red;">WARNING: Auto-index cycles all pages in site page folder, this may take some time.</span><br />';
        warningMsg += 'Auto-index will search for divs marked with class "tc-searchable"<br />';
        if (!searchAdmin.showWarning) {
            $('#logstring').append(warningMsg);
            searchAdmin.showedWarning = true;
        }
    }
}